version: "3.8"

services:
  nextjs-app:
    image: xkcs408wk48s4gsgccgoog4w:4ad5cf602443b2803ea20c0751443639a1ea446c # Replace with your actual Next.js Docker image
    ports:
      - "4016:4016" # Expose port 4016 from container to the host machine
    environment:
      - NODE_ENV=production
    labels:
      # Enable Traefik for this service
      - "traefik.enable=true"

      # HTTP entry point for routing and redirection
      - "traefik.http.routers.http-0-xkcs408wk48s4gsgccgoog4w.entryPoints=http"
      - "traefik.http.routers.http-0-xkcs408wk48s4gsgccgoog4w.middlewares=redirect-to-https"
      - "traefik.http.routers.http-0-xkcs408wk48s4gsgccgoog4w.rule=Host(elsawra.net) && (PathPrefix(/ar) || PathPrefix(/))"
      - "traefik.http.routers.http-0-xkcs408wk48s4gsgccgoog4w.service=http-0-xkcs408wk48s4gsgccgoog4w"

      # Middleware for redirection to HTTPS
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"

      # HTTPS entry point with gzip compression middleware
      - "traefik.http.routers.https-0-xkcs408wk48s4gsgccgoog4w.entryPoints=https"
      - "traefik.http.routers.https-0-xkcs408wk48s4gsgccgoog4w.middlewares=gzip"
      - "traefik.http.routers.https-0-xkcs408wk48s4gsgccgoog4w.rule=Host(elsawra.net) && (PathPrefix(/ar) || PathPrefix(/))"
      - "traefik.http.routers.https-0-xkcs408wk48s4gsgccgoog4w.service=https-0-xkcs408wk48s4gsgccgoog4w"
      - "traefik.http.routers.https-0-xkcs408wk48s4gsgccgoog4w.tls=true"
      - "traefik.http.routers.https-0-xkcs408wk48s4gsgccgoog4w.tls.certresolver=letsencrypt"

      # Load balancer server port for both HTTP and HTTPS
      - "traefik.http.services.http-0-xkcs408wk48s4gsgccgoog4w.loadbalancer.server.port=4016"
      - "traefik.http.services.https-0-xkcs408wk48s4gsgccgoog4w.loadbalancer.server.port=4016"

      # Enable gzip compression for the HTTPS router
      - "traefik.http.middlewares.gzip.compress=true"

  # Traefik Service Configuration (Reverse Proxy)
  traefik:
    image: traefik:v2.5
    command:
      - "--api.insecure=true" # Expose Traefik dashboard (disable in production)
      - "--entrypoints.web.address=:80" # HTTP entry point
      - "--entrypoints.websecure.address=:443" # HTTPS entry point
      - "--providers.docker=true" # Enable Docker provider
      - "--certificatesresolvers.letsencrypt.acme.httpchallenge=true" # Enable Let's Encrypt HTTP challenge
      - "--certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web" # HTTP challenge for SSL
    ports:
      - "80:80" # Expose HTTP port
      - "443:443" # Expose HTTPS port
      - "8080:8080" # Expose Traefik dashboard (optional)
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock" # For Traefik to interact with Docker

  # Optional: Redis for session storage, caching, etc.
  redis:
    image: redis:7-alpine
    restart: always
    volumes:
      - redis_data:/data

  # Optional: PostgreSQL database for persistent storage
  postgres:
    image: postgres:15-alpine
    restart: always
    environment:
      POSTGRES_USER: your_user
      POSTGRES_PASSWORD: your_password
      POSTGRES_DB: your_db
    volumes:
      - postgres_data:/var/lib/postgresql/data

volumes:
  redis_data:
  postgres_data:
